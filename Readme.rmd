---
title: "Workflow Part II: ELM-FATES calibration for Soil Water Potentials"
author: "Rutuja Chitra-Tarak"
date: "12/2/2019"
output: 
  pdf_document: default
subtitle: Hydraulically-vulnerable trees survive on deep-water access during droughts
  in a tropical forest
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### 1. Check forcing data

`code/1.0_Checking_met_data.R`

### 2. Generate parameter files

1.  FATES param files dependencies:
    + Parameter range for roob_b parameters are generated here: 2.0_root_parameters_b.R
    + Can verify that different root a can give same b: data-raw/estimation of root_b_par_same_b_for_different as.xlsx
Other ranges are based on literature, or Zailaa et al. 2020

2.  ELM param files dependencies:
fpi_max ranges are generated from here: 
    + First throughfall from Zimmermann et al and rain data from STRI at Lutz are linked: `code/3.0_Throughfall.R`
    + As rainfall data is not given in Zimmermann and throughfall data is collected for rainfall events (duration, amount and gap between events), rainfall that composes those events are inferred in Excel. Then range of interception is found for events > 10 mm: data-raw/throughfall_rain_hourly_for_inspection_new.xlsx

3.  Surface data files dependencies:
Soil texture data and soil organic content data is gathered and defined here:
`code/4.0_Surfdata_texture_options.R` But these are not used by the model as it is forced with   

    1. soil characteristic curves (Soil Water Content to Soil Water Potential) using Stephan Kupers' data, as well as, bci.hydromet/data-raw/soil_retention_curves_stephan.R

    2. soil hydraulic conductivity, using Godsey & Stallard et al defined here: `code/5.0_Surfdata_Ksat_obs_and_bootstrapped_param.R`

4.  Surface data for ELM, ELM parameters and FATES paramater files 
`code/6.0_Generate_parameter files.R`
These are transferred to the server.

### 3. Run simulations

1. Follow Google Doc 3.0_Running ELM-FATES with parameter ensembles @ Shared drive/Rutuja_work/web_only/ <https://docs.google.com/document/d/1qqbkQGHMG8BMfrUejUlkBU3PvUqPuW0Pc6CBLBQzZZk/edit#heading=h.gjdgxs>

2. Thus run ensemble members and extract simulations on the server with `code/8.0_main.R` (which in turn sources `code/7.0_fun_extract.R`) and transfer back to the desktop storing at a specific dated location such as data-raw/extract/2019-10-14_5000

### 4. Calibration and Sensitivity Analyses

  1. Use `code/09.0_ELM-FATES_output.R` to generate RMSE or Rsq values between simulations and hydrological observations, plot best-fits for individual fluxes and run sensitivity analyses. These outputs are compiled in individual-flux-best-fits.html and Report.html

  2. Use `code/10.0_ELM-FATES_params_bestfit.R` to generate objective function to choose best-fit simulations that fits all individual fluxes well (QRUNOFF, AET, Soil moisture by depth)

  3. Confirm that individual fluxes are well captured by thus chosen best-fits:    `code/11.0_ELM-FATES_output_bestfit.R`

### 4. Re-Run simulations for best-fits for the entire study period

Now for the chosen best-fits re-run simulations covering the entire time-period of 1985-2018
Follow Google Doc 4.0_Running ELM-FATES for best-fit parameter ensembles @ Shared drive/Rutuja_work/web_only/ <https://docs.google.com/document/d/1V2UK_iSdXmkq3jR3TyowW7YllvrC7OVi/edit#heading=h.gjdgxs> (and `code/12.0_Prep_for_Best-fit_case_runs.R` to generate par.sam numbers seperated by commas)

### 5. Extract, plot and save Soil Water Potentials as a data-package

  1. Extract data from server and transfer to desktop at the following location
`data-raw/extract/2019-10-14_5000/best-fits`, 

  2. Then extract and save full swp, btran time-series to be used for generating the data package.
`code/13.0_ELM-FATES_full best-fit_swp.R`

  3. Plot the entire time-series of SWC, SWP and ELM-FATES generated BTRAN for best-fit simulations.
`code/14.0_Plotting best-fits_full.R`


```{r Chunk Readme-data, eval = FALSE}
groundhog.day = "2021-01-01"
groundhog.library('rmarkdown', groundhog.day)
rmarkdown::render("Readme.rmd", output_format = "pdf_document")
rmarkdown::render("Readme_data.rmd", output_format = "pdf_document")
```

